// add API for parsing time estimate
acceptedAPIs.dxf_estimate = [function writeEstimate(data){
	NProgress.done();
	$('.job-time-estimate').val(data.time);

	// move check indicator to file upload
	$('.job-file-upload .time-usage-indicator').removeClass('fa-circle-o').addClass('fa-check-circle');
	$('.manual-time-estimate .time-usage-indicator').addClass('fa-circle-o').removeClass('fa-check-circle');
}]

// once config has been applied
getConfigFile.done(function() {
	// create the file uploader
	formOptions.dxfTime = {
		"type": "generic",
		"noParse": true,
		"template":
		"<div class='btn-group' role='group'>" +
			"<label type='button' for='dxf-file-picker' class='btn dxf-file-picker-label'>" +
				"<span data-form-el-type='file' class='form-control btn-default form-simple-button job-file-upload' data-toggle='tooltip' data-placement='bottom' title='Upload DXF to get automatic time estimate'>" +
					"<i class='fa fa-circle-o time-usage-indicator'></i>Upload DXF <input type='file' id='dxf-file-picker'>" +
				"</span>" +
			"</label>" +
			"<button type='button' class='btn btn-default form-simple-button manual-time-estimate' data-toggle='tooltip' data-placement='bottom' title='Enter cut time estimate manually'><i class='fa fa-circle-o time-usage-indicator'></i>Manual time estimate</button>" +
		"</div>",
		"onRender": function() {
			// hide normal time estimate box and move button to right place
			$('.job-time-estimate').hide();
			// when the file is chosen
			$('#dxf-file-picker').change(function logData(data) {
				var file = $(this).get(0).files[0];
				var read = new FileReader();
				read.readAsBinaryString(file);
				read.onloadend = function transferFile() {
					// send it to the backend
					socketSend({"action": "send_dxf", "dxf_data": read.result});
				}
				// start a loader
				NProgress.start();
			});
			// when user wants to enter manual estimate
			$('.manual-time-estimate').click(function() {
				modalMessage('Custom cut time',
					'<form class="cut-time-form">' +
						'<div class="form-group">' +
							'<label for="cut-time-modal-input">Time</label>' +
							'<input type="number" class="form-control form-pink-input cut-time-modal-input" id="cut-time-modal-input" placeholder="Time (minutes)">' +
						'</div>' +
						'<button type="submit" class="btn btn-pink cut-time-modal-confirm">OK</button>' +
					'</form>'
				);

				// once modal is up, focus time
				setTimeout(function focusTimeField() {
					$(".cut-time-modal-input").focus();
				}, 500);

				// when user clicks OK
				$('.cut-time-modal-confirm').click(function(event) {
					event.preventDefault();
					$("#notify-modal").modal("hide");
					// fill in time
					$('.job-time-estimate').val($('.cut-time-modal-input').val());
					// move check indicator to manual
					$('.job-file-upload .time-usage-indicator').addClass('fa-circle-o').removeClass('fa-check-circle');
					$('.manual-time-estimate .time-usage-indicator').removeClass('fa-circle-o').addClass('fa-check-circle');
				});
			});
		}
	}
	renderForm();
});
